<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics | Aviagen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen flex overflow-hidden">

    <aside class="w-64 bg-[#111827] text-white hidden md:flex flex-col flex-shrink-0 transition-all duration-300">
        <div class="h-16 flex items-center px-6 border-b border-gray-800">
            <div class="h-8 w-8 bg-[#C8102E] rounded-lg flex items-center justify-center font-bold text-lg mr-3">A</div>
            <span class="font-bold text-lg tracking-wide">Aviagen<span class="text-[#C8102E]">Manager</span></span>
        </div>

        <nav class="flex-1 px-4 py-6 space-y-2 overflow-y-auto">
            <a href="#" class="flex items-center gap-3 px-4 py-3 bg-[#C8102E] text-white rounded-lg shadow-lg shadow-red-900/20">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                <span class="font-medium">Dashboard</span>
            </a>
            <a href="os.html" class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                <span class="font-medium">Nova Ordem</span>
            </a>
            <button onclick="logout()" class="flex items-center gap-3 px-4 py-3 text-red-400 hover:bg-gray-800 rounded-lg transition mt-auto w-full text-left">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                <span class="font-medium">Sair do Sistema</span>
            </button>
        </nav>

        <div class="p-4 border-t border-gray-800">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-sm font-bold">JD</div>
                <div>
                    <p class="text-sm font-semibold text-white">UsuÃ¡rio Logado</p>
                    <p class="text-xs text-gray-400">TÃ©cnico / Admin</p>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
        
        <header class="bg-white h-16 border-b border-gray-200 flex items-center justify-between px-8 shadow-sm z-10">
            <h2 class="text-xl font-bold text-gray-800">VisÃ£o Geral</h2>
            <div class="flex items-center gap-4">
                <span class="text-sm text-gray-500 hidden sm:block" id="currentDate">Carregando data...</span>
                <a href="os.html" class="bg-gray-900 hover:bg-black text-white px-4 py-2 rounded-md text-sm font-medium transition shadow-sm">
                    + Nova OS
                </a>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8 bg-gray-50">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition flex flex-col justify-between h-32">
                    <div>
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Abertas</p>
                        <h3 id="openCount" class="text-3xl font-bold text-[#C8102E] mt-1">-</h3>
                    </div>
                    <div class="w-full bg-gray-100 h-1 rounded-full overflow-hidden mt-2">
                        <div class="bg-[#C8102E] h-1 rounded-full" style="width: 45%"></div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition flex flex-col justify-between h-32">
                    <div>
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Finalizadas</p>
                        <h3 id="closedCount" class="text-3xl font-bold text-green-600 mt-1">-</h3>
                    </div>
                    <div class="w-full bg-gray-100 h-1 rounded-full overflow-hidden mt-2">
                        <div class="bg-green-500 h-1 rounded-full" style="width: 75%"></div>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-[#1e293b] to-[#0f172a] p-6 rounded-xl shadow-lg text-white relative overflow-hidden h-auto md:h-32 group">
                    <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition">
                        <svg class="w-16 h-16" fill="currentColor" viewBox="0 0 20 20"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"></path></svg>
                    </div>
                    <p class="text-xs font-bold text-blue-300 uppercase tracking-wider mb-2 flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-blue-400 animate-pulse"></span> IA Insights
                    </p>
                    <p id="iaResumo" class="text-sm font-light leading-relaxed text-gray-300 line-clamp-2">
                        Analisando dados...
                    </p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 lg:col-span-1">
                    <h3 class="font-bold text-gray-800 mb-6 text-sm uppercase tracking-wide">DistribuiÃ§Ã£o de Status</h3>
                    <div class="relative h-64 w-full flex justify-center items-center">
                        <canvas id="osChart"></canvas>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-100 lg:col-span-2 flex flex-col overflow-hidden">
                    <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                        <h3 class="font-bold text-gray-800 text-sm uppercase tracking-wide">Ãšltimas MovimentaÃ§Ãµes</h3>
                        <button class="text-xs font-semibold text-[#C8102E] hover:text-red-700 bg-red-50 px-3 py-1 rounded-full transition">
                            Ver todas
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto flex-1">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="border-b border-gray-100 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                    <th class="px-6 py-4 bg-gray-50">Problema</th>
                                    <th class="px-6 py-4 bg-gray-50">Setor</th>
                                    <th class="px-6 py-4 bg-gray-50">Status</th>
                                    <th class="px-6 py-4 bg-gray-50 text-right">Prioridade</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody" class="text-sm divide-y divide-gray-100">
                                <tr>
                                    <td colspan="4" class="px-6 py-8 text-center text-gray-400 italic">
                                        Carregando dados da tabela...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script>
        const backend = 'https://aviagen-backend-1.onrender.com'
        const token = localStorage.getItem('token')
        const role = localStorage.getItem('role')

        // Data Atual no Header
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('currentDate').innerText = new Date().toLocaleDateString('pt-BR', options);

        if(!token) window.location.href = 'login.html'

        function logout() {
            localStorage.clear()
            window.location.href = 'login.html'
        }

        async function loadData() {
            try {
                // 1. DASHBOARD GERAL (NÃšMEROS)
                const res = await fetch(`${backend}/dashboard`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                })
                
                if (res.status === 401) logout();
                const data = await res.json()
                
                document.getElementById('openCount').innerText = data.abertas || 0
                document.getElementById('closedCount').innerText = data.finalizadas || 0

                // Renderiza GrÃ¡fico
                renderChart(data.abertas, data.finalizadas);

                // 2. IA EXECUTIVA
                if(role === 'admin') {
                    fetch(`${backend}/ia/resumo`, { headers: { 'Authorization': 'Bearer ' + token }})
                        .then(r => r.json())
                        .then(d => {
                            document.getElementById('iaResumo').innerText = d.texto || "Sem insights para hoje.";
                            document.getElementById('iaResumo').classList.remove('line-clamp-2'); // Expande se tiver texto
                        })
                        .catch(() => document.getElementById('iaResumo').innerText = "IA IndisponÃ­vel.")
                } else {
                    document.getElementById('iaResumo').innerText = "Acesso restrito Ã  diretoria."
                }

                // 3. TABELA (Tenta buscar lista de OS)
                // Se seu backend nÃ£o tiver a rota /os (GET), isso vai dar erro, mas tratei no catch.
                try {
                    const resList = await fetch(`${backend}/os`, {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    if(resList.ok) {
                        const listaOS = await resList.json();
                        renderTable(listaOS);
                    } else {
                        renderEmptyTable("Dados de lista nÃ£o disponÃ­veis.");
                    }
                } catch (e) {
                    renderEmptyTable("Aguardando conexÃ£o com banco de dados...");
                }

            } catch (error) {
                console.error(error);
            }
        }

        function renderChart(abertas, finalizadas) {
            const ctx = document.getElementById('osChart');
            const total = (abertas || 0) + (finalizadas || 0);
            const dataSet = total === 0 ? [1] : [abertas, finalizadas];
            const colorSet = total === 0 ? ['#E5E7EB'] : ['#C8102E', '#16A34A'];

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: total === 0 ? ['Sem dados'] : ['Abertas', 'Finalizadas'],
                    datasets: [{
                        data: dataSet,
                        backgroundColor: colorSet,
                        borderWidth: 0,
                        hoverOffset: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } } }
                }
            })
        }

        function renderTable(lista) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            // Pega as 5 Ãºltimas (inverte ordem se vier cronologico)
            const ultimas = lista.slice(-5).reverse(); 

            if(ultimas.length === 0) {
                renderEmptyTable("Nenhuma ordem encontrada.");
                return;
            }

            ultimas.forEach(os => {
                const statusClass = os.status === 'Finalizada' ? 'text-green-600 bg-green-50 border-green-200' : 
                                    os.status === 'Em andamento' ? 'text-blue-600 bg-blue-50 border-blue-200' : 
                                    'text-red-600 bg-red-50 border-red-200';
                
                const prioridadeDot = os.priority === 'Alta' ? 'ðŸ”´' : os.priority === 'MÃ©dia' ? 'ðŸŸ¡' : 'ðŸŸ¢';

                const row = `
                    <tr class="hover:bg-gray-50 transition group cursor-default">
                        <td class="px-6 py-4 font-medium text-gray-900">
                            ${os.description}
                            <div class="text-xs text-gray-400 font-normal mt-0.5">${os.technician || 'Sem tÃ©cnico'}</div>
                        </td>
                        <td class="px-6 py-4 text-gray-500">${os.sector}</td>
                        <td class="px-6 py-4">
                            <span class="${statusClass} px-2.5 py-0.5 rounded-full text-xs font-bold border border-opacity-50">
                                ${os.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-right text-xs text-gray-500">
                            ${prioridadeDot} ${os.priority}
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function renderEmptyTable(msg) {
            document.getElementById('tableBody').innerHTML = `
                <tr><td colspan="4" class="px-6 py-8 text-center text-gray-400 text-sm">${msg}</td></tr>
            `;
        }

        loadData();
    </script>
</body>
</html>
